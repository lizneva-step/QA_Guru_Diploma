# ĞĞ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ workflow â€” Ğ¿Ñ€Ğ¾Ñ„ĞµÑÑĞ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾ Ğ¸ Ğ½ĞµĞ¹Ñ‚Ñ€Ğ°Ğ»ÑŒĞ½Ğ¾
name: Playwright CI Pipeline

# Ğ—Ğ°Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ Ğ¿Ñ€Ğ¸:
# - push Ğ² Ğ²ĞµÑ‚ĞºĞ¸ main/master
# - pull request Ğ² ÑÑ‚Ğ¸ Ğ²ĞµÑ‚ĞºĞ¸
# - Ñ€ÑƒÑ‡Ğ½Ğ¾Ğ¼ Ğ·Ğ°Ğ¿ÑƒÑĞºĞµ Ñ‡ĞµÑ€ĞµĞ· Ğ¸Ğ½Ñ‚ĞµÑ€Ñ„ĞµĞ¹Ñ
on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:

# ĞÑĞ½Ğ¾Ğ²Ğ½Ğ¾Ğ¹ Ğ¿Ñ€Ğ¾Ñ†ĞµÑÑ: Ğ·Ğ°Ğ¿ÑƒÑĞº Ñ‚ĞµÑÑ‚Ğ¾Ğ² Ğ¸ Ğ¾Ñ‚Ñ‡Ñ‘Ñ‚Ğ½Ğ¾ÑÑ‚ÑŒ
jobs:
  ci-tests:
    name: ğŸ§ª Run & Report
    timeout-minutes: 30
    runs-on: ubuntu-latest

    steps:
      # ğŸ” 1. ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ ĞºĞ¾Ğ´ Ğ¸Ğ· Ñ€ĞµĞ¿Ğ¾Ğ·Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ñ
      - name: ğŸ” Checkout code
        uses: actions/checkout@v4

      # âš™ï¸ 2. Ğ£ÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ Node.js Ğ¸ ĞºÑÑˆĞ¸Ñ€ÑƒĞµĞ¼ Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚Ğ¸
      - name: ğŸ“¦ Setup Node.js & Cache
        uses: actions/setup-node@v4
        with:
          node-version: lts/*
          cache: npm

      # ğŸ“¥ 3. Ğ£ÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚Ğ¸
      - name: ğŸ“¥ Install dependencies
        run: npm ci

      # ğŸ•¹ï¸ 4. Ğ£ÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ Playwright Ğ¸ Ğ±Ñ€Ğ°ÑƒĞ·ĞµÑ€Ñ‹
      - name: ğŸŒ Install Playwright
        run: npx playwright install --with-deps

      # â–¶ï¸ 5. Ğ—Ğ°Ğ¿ÑƒÑĞº Ğ²ÑĞµÑ… Ñ‚ĞµÑÑ‚Ğ¾Ğ²
      - name: â–¶ï¸ Execute tests
        run: npm run test

      # ğŸ“ 6. Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ Ğ°Ñ€Ñ‚ĞµÑ„Ğ°ĞºÑ‚Ñ‹ (Ğ²ÑĞµĞ³Ğ´Ğ°)
      - name: ğŸ“ Upload artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results
          path: |
            test-results
            allure-results
          retention-days: 20

      # ğŸ“ˆ 7. ĞŸĞ¾Ğ´Ğ³Ğ¾Ñ‚Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸Ñ Ğ´Ğ»Ñ Allure
      - name: ğŸ—ƒï¸ Fetch previous reports
        uses: actions/checkout@v4
        if: always()
        with:
          ref: gh-pages
          path: gh-pages
          token: ${{ secrets.GITHUB_TOKEN }}

      # ğŸ“Š 8. Ğ“ĞµĞ½ĞµÑ€Ğ¸Ñ€ÑƒĞµĞ¼ HTML-Ğ¾Ñ‚Ñ‡Ñ‘Ñ‚
      - name: ğŸ“Š Generate Allure Report
        uses: simple-elf/allure-report-action@master
        if: always()
        with:
          allure_results: allure-results
          gh_pages: gh-pages
          allure_report: allure-report
          allure_history: allure-history
          keep_reports: 20

      # ğŸŒ 9. ĞŸÑƒĞ±Ğ»Ğ¸ĞºÑƒĞµĞ¼ Ğ¾Ñ‚Ñ‡Ñ‘Ñ‚ Ğ½Ğ° GitHub Pages
      - name: ğŸŒ Deploy Allure Report
        uses: peaceiris/actions-gh-pages@v4
        if: always()
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: allure-history

      # ğŸ“¦ 10. Ğ£ÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ allurectl Ñ ĞºÑÑˆĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸ĞµĞ¼
      - name: ğŸ“¦ Setup allurectl
        if: always()
        run: |
          # ĞšÑÑˆĞ¸Ñ€ÑƒĞµĞ¼ allurectl
          if [ ! -f "/usr/local/bin/allurectl" ]; then
            echo "Installing allurectl..."
            curl -o allurectl -L "https://github.com/allure-framework/allurectl/releases/latest/download/allurectl_linux_amd64"
            chmod +x allurectl
            sudo mv allurectl /usr/local/bin/
          fi

      # â˜ï¸ 11. Ğ—Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°ĞµĞ¼ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ñ‹ Ğ² Allure TestOps
      - name: â˜ï¸ Upload to Allure TestOps
        if: always()
        run: |
          allurectl upload allure-results \
            --endpoint https://allure.autotests.cloud \
            --project-id 4983 \
            --token ${{ secrets.ALLURE_TOKEN }} \
            --launch-name "CI Run #${{ github.run_number }}"

      # ğŸ“‹ 12. Ğ˜Ğ·Ğ²Ğ»ĞµĞºĞ°ĞµĞ¼ ÑÑ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºÑƒ Ğ¸Ğ· Ğ¾Ñ‚Ñ‡Ñ‘Ñ‚Ğ°
      - name: ğŸ“‹ Parse test summary
        id: parse_summary
        if: always()
        run: |
          file="allure-report/widgets/summary.json"
          if [ -f "$file" ]; then
            echo "PASSED=$(jq -r '.statistic.passed' $file)" >> $GITHUB_ENV
            echo "FAILED=$(jq -r '.statistic.failed' $file)" >> $GITHUB_ENV
            echo "SKIPPED=$(jq -r '.statistic.skipped' $file)" >> $GITHUB_ENV
            echo "TOTAL=$(jq -r '.statistic.total' $file)" >> $GITHUB_ENV
          fi

      # ğŸ“¢ 13. ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğµ Ğ² Telegram
      - name: ğŸ“¢ Notify in Telegram
        if: always()
        run: |
          status=${{ job.status }}
          if [ "$status" = "success" ]; then
            emoji="âœ…"
            text="Ğ¢Ğ•Ğ¡Ğ¢Ğ« ĞŸĞ ĞĞ™Ğ”Ğ•ĞĞ«"
          else
            emoji="âŒ"
            text="ĞĞ¨Ğ˜Ğ‘ĞšĞ˜ Ğ’ Ğ¢Ğ•Ğ¡Ğ¢ĞĞ¥"
          fi

          msg="$emoji *$text* $emoji%0A"
          msg+="%0AğŸ“Š *Ğ ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ñ‹*:%0A"
          msg+="â–«ï¸ Ğ’ÑĞµĞ³Ğ¾: *$TOTAL*%0A"
          msg+="âœ… ĞŸÑ€Ğ¾Ğ¹Ğ´ĞµĞ½Ğ¾: *$PASSED*%0A"
          msg+="âŒ Ğ£Ğ¿Ğ°Ğ»Ğ¸: *$FAILED*%0A"
          msg+="â­ï¸ ĞŸÑ€Ğ¾Ğ¿ÑƒÑ‰ĞµĞ½Ğ¾: *$SKIPPED*%0A"
          msg+="%0Aâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”%0A"
          msg+="ğŸ”— [ĞÑ‚Ñ‡Ñ‘Ñ‚ Allure](https://lizneva-step.github.io/QA_Guru_Diploma/)%0A"
          msg+="ğŸ§ª [TestOps](https://allure.autotests.cloud/project/4983)%0A"
          msg+="ğŸ“¦ [ĞÑ€Ñ‚ĞµÑ„Ğ°ĞºÑ‚Ñ‹]($GITHUB_SERVER_URL/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID)%0A"
          msg+="%0AğŸ·ï¸ *Ğ—Ğ°Ğ¿ÑƒÑĞº #${{ github.run_number }}*"

          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d parse_mode=Markdown \
            -d text="$msg"